<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CYBER ORIPA | 脳汁覚醒</title>
<style>
  :root {
    --neon-blue: #00f3ff;
    --neon-purple: #bc13fe;
    --neon-gold: #ffd700;
    --bg-color: #030305;
    --glass: rgba(255, 255, 255, 0.05);
  }

  body {
    margin: 0;
    background-color: var(--bg-color);
    color: #fff;
    font-family: "Arial", sans-serif; /* サイバー感を出すためゴシック系 */
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 100vh;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
    /* 背景のサイバーグリッド */
    background-image: 
      linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
    background-size: 30px 30px;
  }

  /* --- ヘッダー --- */
  header {
    background: rgba(3, 3, 5, 0.9);
    backdrop-filter: blur(10px);
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--neon-blue);
    z-index: 100;
    height: 60px;
    box-sizing: border-box;
    box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
  }
  .header-title { 
    font-style: italic; font-weight: 900; font-size: 18px; 
    text-shadow: 0 0 10px var(--neon-blue);
    letter-spacing: 1px;
  }
  .points-box {
    background: rgba(0,0,0,0.5);
    padding: 5px 15px;
    border-radius: 4px;
    border: 1px solid var(--neon-gold);
    color: var(--neon-gold);
    font-weight: bold;
    text-shadow: 0 0 8px var(--neon-gold);
    font-size: 14px;
    font-family: monospace; /* 数字っぽく */
  }

  /* --- メインエリア --- */
  .main-stage {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    padding-bottom: 100px;
  }

  /* ガチャボックス（デジタルカプセルUI） */
  .gacha-box {
    background: var(--glass);
    border: 1px solid rgba(0, 243, 255, 0.3);
    border-radius: 4px; /* 角張ったデザイン */
    margin-bottom: 30px;
    padding: 1px;
    position: relative;
    clip-path: polygon(
      10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px
    );
    transition: transform 0.2s;
  }
  .gacha-box:active { transform: scale(0.98); }
  
  /* 角の装飾 */
  .gacha-box::before {
    content: ""; position: absolute; top: 0; left: 0; width: 10px; height: 10px;
    border-top: 2px solid var(--neon-blue); border-left: 2px solid var(--neon-blue);
  }
  .gacha-box::after {
    content: ""; position: absolute; bottom: 0; right: 0; width: 10px; height: 10px;
    border-bottom: 2px solid var(--neon-blue); border-right: 2px solid var(--neon-blue);
  }

  .banner {
    width: 100%; height: 140px;
    background: #000;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    position: relative; overflow: hidden;
    margin-bottom: 10px;
  }
  .banner-overlay {
    position: absolute; width: 100%; height: 100%;
    background: linear-gradient(45deg, rgba(0,0,0,0.8), transparent);
    z-index: 1;
  }
  .banner-text {
    font-size: 28px; font-weight: 900; z-index: 2;
    text-transform: uppercase; letter-spacing: 2px;
    font-style: italic;
  }
  .banner-sub {
    font-size: 10px; color: #fff; z-index: 2;
    background: var(--neon-blue); color: #000;
    padding: 2px 8px; margin-top: 5px; font-weight: bold;
  }

  .gacha-controls {
    display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 10px;
  }
  .gacha-btn {
    background: rgba(0, 243, 255, 0.1);
    border: 1px solid var(--neon-blue);
    color: var(--neon-blue);
    padding: 10px;
    font-weight: bold;
    cursor: pointer;
    text-align: center;
    transition: 0.2s;
    font-family: monospace;
  }
  .gacha-btn:hover {
    background: var(--neon-blue); color: #000; box-shadow: 0 0 15px var(--neon-blue);
  }
  .btn-single { grid-column: 1 / 3; background: rgba(255,255,255,0.05); border-color: #fff; color: #fff; }
  .cost-label { display: block; font-size: 10px; opacity: 0.7; }

  /* --- フッター --- */
  .footer-menu {
    background: rgba(0,0,0,0.9);
    border-top: 1px solid #333;
    display: flex; justify-content: space-around;
    padding: 10px 0;
    position: fixed; bottom: 0; left: 0; width: 100%;
    z-index: 900; height: 60px; box-sizing: border-box;
  }
  .menu-item { color: #555; text-align: center; font-size: 10px; cursor: pointer; width: 50%; }
  .menu-item.active { color: var(--neon-blue); text-shadow: 0 0 5px var(--neon-blue); }
  .menu-icon { font-size: 20px; display: block; margin-bottom: 2px; }

  /* --- 演出オーバーレイ (サイバーコア) --- */
  .cutin-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(circle, #1a1a2e 0%, #000 100%);
    z-index: 8000; /* 高めに設定 */
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  /* ヘキサゴン・コア */
  .hex-core-container {
    position: relative;
    width: 200px; height: 200px;
    display: flex; align-items: center; justify-content: center;
  }
  
  .hex-core {
    width: 120px; height: 120px;
    background: #000;
    position: relative;
    display: flex; align-items: center; justify-content: center;
    clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
    border: 2px solid var(--neon-blue);
    box-shadow: 0 0 20px var(--neon-blue), inset 0 0 20px var(--neon-blue);
    z-index: 2;
    transition: 0.3s;
    cursor: pointer;
  }
  
  /* コアの回転リング */
  .core-ring {
    position: absolute;
    width: 180px; height: 180px;
    border: 2px dashed rgba(0, 243, 255, 0.3);
    border-radius: 50%;
    animation: spin-slow 10s linear infinite;
  }
  .core-ring::before {
    content: ""; position: absolute; top: -5px; left: 50%; width: 10px; height: 10px;
    background: var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue);
  }

  /* 状態：青（通常） */
  .hex-core.blue { 
    border-color: var(--neon-blue); 
    box-shadow: 0 0 30px var(--neon-blue);
  }
  .hex-core.blue .core-text { color: var(--neon-blue); text-shadow: 0 0 5px var(--neon-blue); }

  /* 状態：紫（昇格/暴走） */
  .hex-core.purple { 
    border-color: var(--neon-purple); 
    box-shadow: 0 0 50px var(--neon-purple), inset 0 0 30px var(--neon-purple);
    animation: shake 0.1s infinite;
  }
  .hex-core.purple .core-text { color: var(--neon-purple); text-shadow: 0 0 10px var(--neon-purple); }

  /* 状態：金/虹（確定） */
  .hex-core.gold {
    border-color: var(--neon-gold);
    background: #fff;
    box-shadow: 0 0 80px var(--neon-gold), 0 0 150px var(--neon-gold);
    animation: spin-fast 0.5s linear infinite;
  }

  .core-text {
    font-family: "Arial Black", sans-serif;
    font-size: 20px; font-weight: 900;
    pointer-events: none;
  }

  .tap-hint {
    margin-top: 40px; color: #fff; letter-spacing: 3px; font-size: 12px;
    animation: blink 1s infinite;
  }

  /* --- 結果画面 --- */
  .result-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.95);
    z-index: 7000; /* 演出より下、ヘッダーより上 */
    display: none; /* デフォルト非表示 */
    flex-direction: column;
    padding: 20px; box-sizing: border-box;
  }
  
  .result-header {
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px;
  }
  .result-title { font-size: 24px; font-style: italic; font-weight: 900; color: #fff; }
  .close-btn {
    background: transparent; border: 1px solid #fff; color: #fff;
    padding: 5px 15px; cursor: pointer; border-radius: 20px;
  }

  .grid-container {
    flex: 1; overflow-y: auto;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
    gap: 10px;
    padding-bottom: 50px;
  }

  .card-item {
    aspect-ratio: 2/3;
    background: #111;
    border-radius: 4px;
    position: relative;
    overflow: hidden;
    border: 1px solid #333;
    opacity: 0; /* アニメーション用 */
    transform: scale(0.5);
  }
  
  /* レアリティ演出 */
  .card-item.SSR { 
    border: 2px solid var(--neon-gold); 
    box-shadow: 0 0 15px var(--neon-gold); 
  }
  .card-item.SR { border: 1px solid var(--neon-purple); box-shadow: 0 0 5px var(--neon-purple); }
  
  .card-item img { width: 100%; height: 100%; object-fit: cover; }
  
  .card-info {
    position: absolute; bottom: 0; width: 100%;
    background: rgba(0,0,0,0.8);
    font-size: 9px; text-align: center; color: #fff; padding: 2px 0;
  }

  /* --- インベントリ --- */
  .inventory-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #050505;
    z-index: 6000;
    display: none;
    flex-direction: column;
  }
  .inv-header { padding: 15px; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 10px; }
  .inv-grid { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; }
  .action-bar { padding: 15px; background: #111; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
  
  /* 選択状態 */
  .card-item.selected { border: 2px solid var(--neon-red); opacity: 0.6; }
  .card-item.selected::after { content: "売却"; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: var(--neon-red); padding: 2px 5px; font-size: 10px; }

  /* --- エフェクト --- */
  .flash-bang {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #fff; z-index: 9999;
    opacity: 0; pointer-events: none;
  }
  .flash-active { animation: flash-anim 0.5s forwards; }

  @keyframes spin-slow { 100% { transform: rotate(360deg); } }
  @keyframes spin-fast { 100% { transform: rotate(360deg); } }
  @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(1px, -1px); } }
  @keyframes blink { 50% { opacity: 0.3; } }
  @keyframes flash-anim { 0% { opacity: 0; } 10% { opacity: 1; } 100% { opacity: 0; } }
  @keyframes card-pop { to { opacity: 1; transform: scale(1); } }

</style>
</head>
<body>

<header>
  <div class="header-title">CYBER ORIPA</div>
  <div class="points-box" id="headerPoints">999,999,999</div>
</header>

<div class="main-stage" id="gachaContainer"></div>

<div class="footer-menu">
  <div class="menu-item active" onclick="showMain()">
    <span class="menu-icon">⬢</span>CORE
  </div>
  <div class="menu-item" onclick="openInventory()">
    <span class="menu-icon">▤</span>STORAGE
  </div>
</div>

<div class="cutin-overlay" id="cutinOverlay">
  <div class="hex-core-container">
    <div class="core-ring"></div>
    <div class="hex-core blue" id="hexCore">
      <span class="core-text">PUSH</span>
    </div>
  </div>
  <div class="tap-hint">TAP TO OVERLOAD</div>
</div>

<div class="result-overlay" id="resultScreen">
  <div class="result-header">
    <span class="result-title">SYSTEM_RESULT</span>
    <button class="close-btn" onclick="closeResult()">CLOSE [×]</button>
  </div>
  <div class="grid-container" id="resultGrid"></div>
</div>

<div class="inventory-overlay" id="inventoryScreen">
  <div class="inv-header">
    <button class="close-btn" onclick="showMain()">← BACK</button>
    <span style="font-weight:bold;">STORAGE</span>
  </div>
  <div class="inv-grid" id="inventoryGrid"></div>
  <div class="action-bar">
    <div style="font-size:12px; color:#aaa;">
      Selected: <span id="sellCount" style="color:#fff;">0</span><br>
      Value: <span id="sellValue" style="color:var(--neon-gold);">0</span> pt
    </div>
    <button class="close-btn" id="sellBtn" onclick="sellSelectedCards()" style="background:var(--neon-red); border:none;" disabled>SELL ALL</button>
  </div>
</div>

<div class="flash-bang" id="flashBang"></div>

<script>
  /* --- 確率・還元率設計 --- */
  let userPoints = 999999999;
  let myCards = [];
  let tempResults = [];
  let maxRarityVal = 0;
  let currentPhase = 0; // 0:Idle, 1:Blue, 2:Purple, 3:Gold

  const TIERS = [
    {
      price: 500,
      name: "BEGINNER_CORE",
      sub: "Rebate: 80%~ / Risk: Low",
      color: "var(--neon-blue)",
      pool: [
        { r:"SSR", w:0.5, pt:20000, name:"Genesis Dragon" },
        { r:"SR", w:3, pt:3000, name:"Cyber Mage" },
        { r:"R", w:20, pt:550, name:"Neon Soldier" },
        { r:"C", w:76.5, pt:420, name:"Data Scrap" }
      ]
    },
    {
      price: 1000,
      name: "STANDARD_CORE",
      sub: "Rebate: 94% / Risk: Med",
      color: "var(--neon-purple)",
      pool: [
        { r:"SSR", w:1, pt:50000, name:"Plasma Dragon" },
        { r:"SR", w:5, pt:5000, name:"Void Walker" },
        { r:"R", w:20, pt:1100, name:"Energy Pod" },
        { r:"C", w:74, pt:850, name:"Glitch Mob" }
      ]
    },
    {
      price: 2000,
      name: "ULTIMATE_CORE",
      sub: "Rebate: ??? / Risk: High",
      color: "var(--neon-gold)",
      pool: [
        { r:"SSR", w:1.5, pt:150000, name:"The Architect" },
        { r:"SR", w:8, pt:10000, name:"Dark Knight" },
        { r:"R", w:25, pt:2100, name:"Revive Code" },
        { r:"C", w:65.5, pt:1600, name:"Slime.exe" }
      ]
    }
  ];

  // --- 初期化 ---
  updateUI();
  renderGachaList();

  function updateUI() {
    document.getElementById('headerPoints').innerText = userPoints.toLocaleString();
  }

  function renderGachaList() {
    const container = document.getElementById('gachaContainer');
    container.innerHTML = "";
    TIERS.forEach(tier => {
      const box = document.createElement('div');
      box.className = 'gacha-box';
      
      box.innerHTML = `
        <div class="banner">
          <div class="banner-overlay" style="background: linear-gradient(45deg, ${tier.color}22, #000);"></div>
          <div class="banner-text" style="color:${tier.color}">${tier.name}</div>
          <div class="banner-sub">${tier.sub}</div>
        </div>
        <div class="gacha-controls">
          <div class="gacha-btn btn-single" onclick="initGacha(${tier.price}, 1)">
            SINGLE<br><span class="cost-label">${tier.price} pt</span>
          </div>
          <div class="gacha-btn" onclick="initGacha(${tier.price}, 10)">
            x10<br><span class="cost-label">${tier.price*10} pt</span>
          </div>
          <div class="gacha-btn" onclick="initGacha(${tier.price}, 100)">
            x100<br><span class="cost-label">${tier.price*100} pt</span>
          </div>
        </div>
      `;
      container.appendChild(box);
    });
  }

  // --- ガチャロジック ---
  function initGacha(price, count) {
    // ポイント減算（テストモードなのでチェックのみ）
    // if(userPoints < price*count) { alert("Insufficient Points"); return; }
    
    // 抽選処理
    tempResults = [];
    maxRarityVal = 0;
    const tierData = TIERS.find(t => t.price === price);
    const totalW = tierData.pool.reduce((a,c)=>a+c.w, 0);

    for(let i=0; i<count; i++){
      let r = Math.random() * totalW;
      let card = tierData.pool[tierData.pool.length-1];
      for(let c of tierData.pool){
        r -= c.w;
        if(r < 0) { card = c; break; }
      }
      
      // 画像生成 (Placehold.jp)
      const colorMap = { SSR:'000000', SR:'aa00aa', R:'0055aa', C:'333333' };
      const imgUrl = `https://placehold.jp/30/${colorMap[card.r]}/ffffff/150x225.png?text=${card.r}%0A${encodeURIComponent(card.name)}`;

      tempResults.push({
        uid: Date.now() + Math.random(),
        ...card,
        img: imgUrl
      });

      // 演出用レア度チェック
      let v = 0;
      if(card.r === 'SR') v=1;
      if(card.r === 'SSR') v=2;
      if(v > maxRarityVal) maxRarityVal = v;
    }

    startAnimation();
  }

  // --- 演出フロー ---
  function startAnimation() {
    const overlay = document.getElementById('cutinOverlay');
    const core = document.getElementById('hexCore');
    const txt = core.querySelector('.core-text');
    
    overlay.style.display = 'flex';
    
    // Phase 1: Blue (Idle -> Active)
    currentPhase = 0;
    core.className = 'hex-core blue';
    txt.innerText = "PUSH";
    
    core.onclick = () => {
      // Phase 2: Purple (Overload)
      if(currentPhase === 0) {
        currentPhase = 1;
        core.className = 'hex-core purple';
        txt.innerText = "LOAD...";
        
        // 溜め時間
        setTimeout(() => {
          // SSRなら確定演出へ
          if(maxRarityVal >= 2 || Math.random() < 0.3) {
             currentPhase = 2;
             core.className = 'hex-core gold';
             txt.innerText = "SSS";
          }
          
          // ホワイトアウトして結果へ
          setTimeout(() => {
            triggerFlash();
          }, 800);
          
        }, 1500); // 1.5秒溜める
      }
    };
  }

  function triggerFlash() {
    const flash = document.getElementById('flashBang');
    flash.classList.add('flash-active');
    
    // フラッシュの真っ白なタイミングで画面切り替え
    setTimeout(() => {
      document.getElementById('cutinOverlay').style.display = 'none';
      showResult();
    }, 200); 

    setTimeout(() => {
      flash.classList.remove('flash-active');
    }, 600);
  }

  // --- 結果表示 ---
  function showResult() {
    const screen = document.getElementById('resultScreen');
    const grid = document.getElementById('resultGrid');
    grid.innerHTML = "";
    
    screen.style.display = 'flex'; // ★ここが表示トリガー

    tempResults.forEach((card, i) => {
      myCards.push(card); // 在庫追加

      const el = document.createElement('div');
      el.className = `card-item ${card.r}`;
      // パラパラ表示アニメーション
      el.style.animation = `card-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards ${i * 0.05}s`;
      
      el.innerHTML = `
        <img src="${card.img}">
        <div class="card-info">
          <span style="color:${card.r==='SSR'?'gold':'white'}">${card.r}</span><br>
          ${card.pt.toLocaleString()}
        </div>
      `;
      grid.appendChild(el);
    });
  }

  function closeResult() {
    document.getElementById('resultScreen').style.display = 'none';
  }

  // --- インベントリ & 売却 ---
  function showMain() {
    document.getElementById('inventoryScreen').style.display = 'none';
  }

  let selectedSet = new Set();

  function openInventory() {
    document.getElementById('inventoryScreen').style.display = 'flex';
    renderInventory();
  }

  function renderInventory() {
    const grid = document.getElementById('inventoryGrid');
    grid.innerHTML = "";
    selectedSet.clear();
    updateSellInfo();

    if(myCards.length === 0) {
      grid.innerHTML = "<div style='color:#555; grid-column:1/-1; text-align:center; margin-top:50px;'>NO DATA</div>";
      return;
    }

    [...myCards].reverse().forEach(card => {
      const el = document.createElement('div');
      el.className = `card-item ${card.r}`;
      // すでにアニメーション済みなのでopacity1
      el.style.opacity = 1;
      el.style.transform = 'scale(1)';
      
      el.innerHTML = `
        <img src="${card.img}">
        <div class="card-info">${card.pt.toLocaleString()}</div>
      `;
      
      el.onclick = () => {
        if(selectedSet.has(card.uid)) {
          selectedSet.delete(card.uid);
          el.classList.remove('selected');
        } else {
          selectedSet.add(card.uid);
          el.classList.add('selected');
        }
        updateSellInfo();
      };
      
      grid.appendChild(el);
    });
  }

  function updateSellInfo() {
    const count = selectedSet.size;
    let total = 0;
    selectedSet.forEach(uid => {
      const c = myCards.find(x => x.uid === uid);
      if(c) total += c.pt;
    });
    
    document.getElementById('sellCount').innerText = count;
    document.getElementById('sellValue').innerText = total.toLocaleString();
    document.getElementById('sellBtn').disabled = (count === 0);
  }

  function sellSelectedCards() {
    if(selectedSet.size === 0) return;
    if(!confirm("Sell selected cards?")) return;
    
    let total = 0;
    myCards = myCards.filter(c => {
      if(selectedSet.has(c.uid)) {
        total += c.pt;
        return false;
      }
      return true;
    });
    
    userPoints += total;
    updateUI();
    renderInventory();
  }

</script>
</body>
</html>
