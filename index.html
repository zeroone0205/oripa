<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>脳汁オリパ | 激アツ演出Ver</title>
<style>
  :root {
    --gold: #FFD700;
    --rainbow: linear-gradient(124deg, #ff2400, #e81d1d, #e8b71d, #e3e81d, #1de840, #1ddde8, #2b1de8, #dd00f3, #dd00f3);
    --bg-dark: #0a0a0a;
  }

  body {
    margin: 0;
    background-color: var(--bg-dark);
    color: #fff;
    font-family: sans-serif;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    user-select: none; /* 連打時の選択防止 */
  }

  /* ★ ヘッダー（ポイント表示） */
  header {
    background: rgba(0,0,0,0.8);
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #333;
    position: sticky; top: 0; z-index: 100;
  }
  .points-box {
    background: #222;
    padding: 5px 15px;
    border-radius: 20px;
    border: 1px solid var(--gold);
    color: var(--gold);
    font-weight: bold;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
  }

  /* ★ メインエリア */
  .main-stage {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    position: relative;
  }

  /* ガチャ筐体画像（CSSで表現） */
  .gacha-machine {
    width: 280px;
    height: 400px;
    background: #111;
    border: 2px solid #444;
    border-radius: 10px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 30px rgba(0,0,0,0.8);
    background-image: url('https://placehold.jp/3d4070/ffffff/300x400.png?text=TAP%20TO%20PULL');
    background-size: cover;
    transition: transform 0.1s;
  }

  /* ボタン */
  .pull-btn {
    margin-top: 30px;
    background: linear-gradient(180deg, #ff6b6b, #c0392b);
    border: none;
    padding: 15px 60px;
    color: white;
    font-size: 24px;
    font-weight: 900;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: 0 6px 0 #96281b, 0 10px 20px rgba(255,0,0,0.4);
    transition: all 0.1s;
    position: relative;
    overflow: hidden;
  }
  .pull-btn:active {
    transform: translateY(4px);
    box-shadow: 0 2px 0 #96281b;
  }
  .pull-btn::after { /* キラリと光る線 */
    content: "";
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);
    transform: rotate(30deg);
    animation: shine 3s infinite;
  }

  @keyframes shine {
    0% { left: -100%; }
    20% { left: 100%; }
    100% { left: 100%; }
  }

  /* ★ 演出レイヤー（最初は非表示） */
  .effect-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.95);
    z-index: 999;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  /* カード本体（裏面・表面） */
  .card-container {
    width: 260px;
    height: 360px;
    perspective: 1000px;
    position: relative;
  }
  .card-inner {
    width: 100%; height: 100%;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .card-face {
    position: absolute; width: 100%; height: 100%;
    backface-visibility: hidden;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.8);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
  }
  
  /* 裏面デザイン */
  .card-back {
    background: #222;
    border: 2px solid #555;
    background-image: repeating-linear-gradient(45deg, #222 0, #222 10px, #2a2a2a 10px, #2a2a2a 20px);
  }
  .card-back::before {
    content: "ORIPA";
    color: #444; font-size: 30px; font-weight: 900;
    transform: rotate(-45deg);
  }

  /* 表面デザイン */
  .card-front {
    background: #000;
    transform: rotateY(180deg);
    overflow: hidden;
    border: 4px solid #fff;
  }
  .card-img {
    width: 100%; height: 100%;
    object-fit: cover;
  }
  .rarity-badge {
    position: absolute; top: 10px; right: 10px;
    background: rgba(0,0,0,0.8);
    padding: 5px 10px;
    border-radius: 4px;
    font-weight: bold;
    border: 1px solid #fff;
    z-index: 2;
  }

  /* ★ アニメーション定義 */
  
  /* 1. ガタガタ震える */
  .shake-hard {
    animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite;
  }
  @keyframes shake {
    10%, 90% { transform: translate3d(-2px, 0, 0) rotate(-1deg); }
    20%, 80% { transform: translate3d(4px, 0, 0) rotate(2deg); }
    30%, 50%, 70% { transform: translate3d(-8px, 0, 0) rotate(-4deg); }
    40%, 60% { transform: translate3d(8px, 0, 0) rotate(4deg); }
  }

  /* 2. 発光 */
  .glowing {
    box-shadow: 0 0 50px rgba(255, 255, 255, 0.8);
    transition: box-shadow 0.5s;
  }

  /* 3. 虹色背景（SSR用） */
  .rainbow-bg {
    background: var(--rainbow);
    background-size: 400% 400%;
    animation: rainbow-move 2s ease infinite;
  }
  @keyframes rainbow-move { 
    0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%}
  }

  /* 4. ホワイトアウト（画面真っ白） */
  .flash-bang {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: white;
    z-index: 10000;
    opacity: 0;
    pointer-events: none;
  }
  .flash-active {
    animation: flash 0.8s ease-out forwards;
  }
  @keyframes flash {
    0% { opacity: 0; }
    50% { opacity: 1; }
    100% { opacity: 0; }
  }

  /* 結果表示後のボタン */
  .result-actions {
    margin-top: 30px;
    display: none; /* 最初は隠す */
    gap: 15px;
    z-index: 1001;
  }
  .action-btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: 1px solid #fff;
    background: rgba(0,0,0,0.5);
    color: #fff;
    cursor: pointer;
    font-weight: bold;
  }
  .primary-btn {
    background: var(--gold);
    color: #000;
    border: none;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
  }

  /* 紙吹雪 */
  .confetti {
    position: absolute;
    width: 10px; height: 10px;
    background-color: #ffd700;
    animation: fall linear forwards;
  }
  @keyframes fall {
    to { transform: translateY(100vh) rotate(720deg); }
  }

</style>
</head>
<body>

<header>
  <div>TCG ORIPA</div>
  <div class="points-box">10,000 pt</div>
</header>

<div class="main-stage">
  <div class="gacha-machine" id="machine"></div>
  
  <div style="margin-top:10px; font-size:12px; color:#aaa;">1回 500pt</div>
  
  <button class="pull-btn" id="pullBtn" onclick="startGacha()">PULL !</button>
</div>

<div class="effect-overlay" id="overlay">
  
  <div class="card-container">
    <div class="card-inner" id="cardInner">
      
      <div class="card-face card-back" id="cardBack"></div>
      
      <div class="card-face card-front" id="cardFront">
        <div class="rarity-badge" id="resRarity">SSR</div>
        <img src="" id="resImg" class="card-img" />
        <div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.7); padding:10px; text-align:center;">
          <div id="resName" style="font-size:14px; font-weight:bold;"></div>
          <div id="resPoint" style="font-size:18px; color:var(--gold); font-weight:900;"></div>
        </div>
      </div>

    </div>
  </div>

  <div class="result-actions" id="resultActions">
    <button class="action-btn" onclick="closeOverlay()">閉じる</button>
    <button class="action-btn primary-btn" onclick="retryGacha()">もう一回 (500pt)</button>
  </div>

</div>

<div class="flash-bang" id="flashBang"></div>

<script>
  // ★ カードデータ（確率はここで調整）
  const CARD_DATA = [
    { id: 1, name: "伝説のドラゴン [神]", rarity: "SSR", probability: 2, point: 50000, img: "https://placehold.jp/30/000000/ffffff/260x360.png?text=SSR%20DRAGON" },
    { id: 2, name: "美少女トレーナー [金]", rarity: "SR", probability: 10, point: 5000, img: "https://placehold.jp/30/aa8800/ffffff/260x360.png?text=SR%20GIRL" },
    { id: 3, name: "汎用サポート [銀]", rarity: "R", probability: 30, point: 1000, img: "https://placehold.jp/30/555555/ffffff/260x360.png?text=R%20SUPPORT" },
    { id: 4, name: "ノーマルカードA", rarity: "C", probability: 58, point: 100, img: "https://placehold.jp/30/333333/aaaaaa/260x360.png?text=Normal" }
  ];

  let currentPoints = 10000;
  const COST = 500;

  // ガチャ抽選ロジック
  function drawCard() {
    const rand = Math.random() * 100;
    let accumulated = 0;
    for (const card of CARD_DATA) {
      accumulated += card.probability;
      if (rand < accumulated) {
        return card;
      }
    }
    return CARD_DATA[CARD_DATA.length - 1];
  }

  // ★ 演出開始
  function startGacha() {
    if (currentPoints < COST) {
      alert("ポイントが足りません！");
      return;
    }
    
    // ポイント消費
    currentPoints -= COST;
    document.querySelector('.points-box').innerText = currentPoints.toLocaleString() + " pt";

    const result = drawCard();
    playAnimation(result);
  }

  // ★ 脳汁演出フロー
  async function playAnimation(card) {
    const overlay = document.getElementById('overlay');
    const cardBack = document.getElementById('cardBack');
    const cardInner = document.getElementById('cardInner');
    const flashBang = document.getElementById('flashBang');
    const actions = document.getElementById('resultActions');
    
    // 1. 初期化
    overlay.style.display = 'flex';
    overlay.classList.remove('rainbow-bg');
    actions.style.display = 'none';
    cardInner.style.transform = 'rotateY(0deg)'; // 裏向きに戻す
    cardBack.classList.remove('shake-hard', 'glowing');
    
    // 2. 溜め（振動）
    // SSRなら振動時間を長くして期待感を煽る
    const waitTime = card.rarity === 'SSR' ? 2500 : 1500;
    
    cardBack.classList.add('shake-hard');
    
    // 徐々に発光させる
    setTimeout(() => {
      cardBack.classList.add('glowing');
    }, 500);

    // 3. ホワイトアウト＆確定
    await new Promise(r => setTimeout(r, waitTime));
    
    flashBang.classList.add('flash-active');
    
    // フラッシュ中にデータをセット＆背景変更
    setTimeout(() => {
      setResultData(card);
      
      // SSRなら背景を虹色に
      if (card.rarity === 'SSR') {
        overlay.classList.add('rainbow-bg');
        spawnConfetti(); // 紙吹雪発射
      }
      
      // カードをめくる
      cardBack.classList.remove('shake-hard', 'glowing');
      cardInner.style.transform = 'rotateY(180deg)';
      
      // ボタン表示
      actions.style.display = 'flex';
      
    }, 400); // フラッシュが真っ白になったタイミングで切り替え

    // フラッシュアニメーションのリセット
    setTimeout(() => {
      flashBang.classList.remove('flash-active');
    }, 1000);
  }

  function setResultData(card) {
    document.getElementById('resRarity').innerText = card.rarity;
    document.getElementById('resName').innerText = card.name;
    document.getElementById('resPoint').innerText = card.point.toLocaleString() + " pt還元";
    
    // SSRなら画像を豪華にする（ここではボーダー色変更で表現）
    const front = document.getElementById('cardFront');
    if (card.rarity === 'SSR') {
      front.style.border = '4px solid gold';
      front.style.boxShadow = '0 0 30px gold';
      document.getElementById('resRarity').style.background = 'linear-gradient(45deg, gold, orange)';
      document.getElementById('resRarity').style.color = 'black';
    } else {
      front.style.border = '4px solid #fff';
      front.style.boxShadow = 'none';
      document.getElementById('resRarity').style.background = 'rgba(0,0,0,0.8)';
      document.getElementById('resRarity').style.color = 'white';
    }
    
    // 画像セット (プレースホルダー)
    document.getElementById('resImg').src = card.img;
  }

  function closeOverlay() {
    document.getElementById('overlay').style.display = 'none';
    // 紙吹雪を消す
    document.querySelectorAll('.confetti').forEach(e => e.remove());
  }

  function retryGacha() {
    closeOverlay();
    setTimeout(startGacha, 100);
  }

  // ★ 紙吹雪生成（SSR用）
  function spawnConfetti() {
    const overlay = document.getElementById('overlay');
    for (let i = 0; i < 50; i++) {
      const confetti = document.createElement('div');
      confetti.classList.add('confetti');
      confetti.style.left = Math.random() * 100 + 'vw';
      confetti.style.top = -10 + 'px';
      confetti.style.backgroundColor = ['#FFD700', '#FFF', '#FF0000'][Math.floor(Math.random() * 3)];
      confetti.style.animationDuration = (Math.random() * 2 + 1) + 's';
      overlay.appendChild(confetti);
    }
  }

</script>
</body>
</html>